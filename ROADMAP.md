# Roadmap

- ðŸ¥‡v0.1: MVP
    - Minimum CI /CD.
    - Basic types: `File`, `APTPackage`, `SystemdUnit`.
    - CLI with basic commands.

## Backlog

- GitHub Action
    - `.github/actions/build.yaml`
        - Use same go version from go.mod
            - Add a check for that.
        - ðŸ¥‡Call `make ci`
        - Add check for test code coverage (integrate with badge).
        - `actions/cache`
            - `GOMODCACHE`
                - path: `go env GOMODCACHE`
                - key: `${{ runner.os }}-gomodcache-${{ hashFiles('**/go.sum') }}`
                - restore-keys: `${{ runner.os }}-gomodcache-`
            - `GOCACHE`
                - path: `go env GOCACHE`
                - key: `${{ runner.os }}-gocache-${{ hashFiles('**/go.sum') }}-${{ hahFiles('**/*.go') }}`
                - restore-keys: `${{ runner.os }}-gocache-`
            - `staticcheck`
                - path: `$XDG_CACHE_HOME/staticcheck` or `$HOME/.cache/staticcheck`
                - key: `${{ runner.os }}-staticcheck-${{ hashFiles('**/go.sum') }}-${{ hahFiles('**/*.go') }}`
                - restore-keys: `${{ runner.os }}-staticcheck-`
    - `.github/workflows/pull_request.yaml`
        - ðŸ¥‡Triggers on all pull requests.
        - ðŸ¥‡Runs `.github/actions/build.yaml`
        - Use same base image as `devenv.sh`.
            - Add check to ensure both are in sync.
    - `.github/workflows/push.yaml`
        - ðŸ¥‡Triggers on push to `master`.
        - ðŸ¥‡Runs `.github/actions/build.yaml`
        - Use same base image as `devenv.sh`.
            - Add check to ensure both are in sync.
    - `.github/workflows/release.yaml`
        - https://github.com/softprops/action-gh-release
        - ðŸ¥‡Triggers on created tag
        - ðŸ¥‡Publish binary for linux-amd64.
        - Publish GH Package
            - Container / Docker registry, so resonance can be used via `docker run`.
- README.md
    - Add badges
      - ðŸ¥‡GH actions state
      - ðŸ¥‡Version
      - Coverage
- Add TESTS!
- `Makefile`
    - Cache `install-deps`.
    - Add https://github.com/gordonklaus/ineffassign
    - Add https://github.com/client9/misspell
- `host/`
    - `local.go`
        - Use [subreaper to wait on all children](https://github.com/fornellas/rrb/blob/main/runner/runner.go).
        - Add option to use sudo to run commands.
    - `ssh.go`
        - Implement using Go Ssh libraries.
        - Add option to use sudo to run commands.
- `resource/`
    - `alternatives.go`
        - Implement with `update-alternatives`.
    - `apt_update.go`
        - Calls `apt-get update`.
        - There should be a single resource declaration
            - Implicitly added if not present.
        - It must be `refreshed_by` `APTRepository`.
        - Parameters can be "freshness", so eg, if update is > freshness, then do update.
    - `apt_repository.go`:
        - Use `add-apt-repository` to add at `/etc/apt/sources.list.d`
    - `apt_package.go`
        - Support directly passing `.deb` packages.
        - Enforce after `File[/etc/apt/preferences.d/.+]`.
    - `file.go`
        - Type: regular, link, dir, char device, block device, pipe, socket.
        - `Check`
            - Print colored diff on content difference.
    - `group.go`
        - Manage groups.
        - Mergeable.
    - `user.go`
        - After `Group[.+]`.
        - Mergeable.
    - `resource.go`
        - `ResourceDefinition`
            - Change `Parameters` to `interface{}` and unmarshall it from `ResourceDefinitionSchema.Parameters` at `ResourceDefinition.UnmarshalYAML`.
                - Thus pulls unmarshall errors when loading, and not when running.
        - `Plan.Execute`
            - ðŸ¥‡On success, save `ResourceBundles` to `PersistantState`.
            - ðŸ¥‡At the end check again, fail if changes detected (bug in implementation).
            - ðŸ¥‡Auto-rollback saved state on failures.
            - Parallelise check.
        - `PersistantState`
            - ðŸ¥‡Change interface to only read / write `[]bytes`, so that serialization code can be shared across all interface implementations.
            - ðŸ¥‡Add field with resonance version at schema.
            - Save history of states: enable to rollback to any previous state.
            - Local state: save to `XDG_STATE_HOME/resonance/$target_hostname/`
        - `LoadResourceBundles`
            - ðŸ¥‡Receive a single directory and load recursively from it.
            - Go templates
                - Before parsing yaml, Go template each resource bundle yaml.
                - Template is a function of:
                    - `--host-parameters parms.yaml`, containing host specific stuff (Eg: secrets)
                    - `HostInventory`
                        - General information about the host.
                        - Must only contains things that are NOT affected by any resource (eg: CPU, memory etc.)
                        - Should save with state and check for changes?
                        - After apply, reload `HostInventory`
                            - If there are any changes, it means an implementation bug.
                            - There may be valid corner cases here. In such scenarios:
                                - `--allow-inventory-changes` have apply re-run when inventory changes at the end.
                                - Should put a limit (otherwise, inifinite loops can happen).
        - `ResourceDefinition`
            - Support `refreshed_by`, to enable resources to subscribe to others (eg: `SystemdUnit[nginx.service]` is `refreshed_by` `File[/etc/nginx/.+]`)
        - `ManageableResource`
            - Support defining implicit dependencies (eg: APTSource before APTPackage)
            - Check if current host OS is supported.
        - `Plan`
            - `Execute`
                - Apply nodes concurrently for cases where it can be done (eg: no refresh)
        - Output
            - Use the output of one resource as parameter for another.
                - Eg: a service creates an ID which another resource depends on.
    - ðŸ¥‡`systemd_unit.go`
        - Manages https://www.freedesktop.org/software/systemd/man/systemd.unit.html
        - Calls `systemctl daemon-reload` on change.
        - On refresh, do `systemctl reload-or-restart $unit`.
- `cli/`
    - ðŸ¥‡`**/cmd.go`
        - ^C cancel context
    - ðŸ¥‡`check/cmd.go`: implement: checks host state / resources against host.
    - `plan/cmd.go`:
        - ðŸ¥‡implement: checks host state / resources and calculate plan against host.
        - ðŸ¥‡Add `--graphviz` option
        - Add `--svg option` (generate the svg directly from the internal graphviz)
    - `lint/cmd.go`: implement:
        - Validate resource definitions
        - Lint yaml (format & sort)
    - `refresh/cmd.go`
        - ðŸ¥‡Update state to match declared resources.
    - `destroy/cmd.go`
        - ðŸ¥‡Destroy all resources at state.
    - `restore/cmd.go`
        - ðŸ¥‡Restore machine to saved state.