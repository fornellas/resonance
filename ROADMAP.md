# Roadmap

- ðŸ§ªv0.1: MVP
    - Minimum CI /CD.
    - Basic types: `File`, `APTPackage`, `SystemdUnit`.
    - CLI with basic commands.
- âœ¨v0.2: Refinement
    - Add tests
    - Toughen CI
    - Speed, refine existing features, squash bugs.
    - Improve dependencies (type implicit and subscription).
- ðŸ“ˆv0.3 Expansion
    - Publish packages.
    - SSH support.
    - More resource types.
- ðŸ“„v0.4 Templating
    - Host inventory.
    - Generate resources with Go template.
    - "High level" resources can declare "primitive" resources.
- ðŸŒŽv1.0 Core features complete
- ðŸ’¡v? TBD
    - Support different Linux Distributions (eg: some resources may require slightly different implementations).
    - Manage multiple hosts: do in parallel, all or nothnig for the whole group.

## Backlog

- GitHub Action
    - `.github/actions/build.yaml`
        - âœ¨Use same go version from go.mod: add a check for that.
        - ðŸ§ªCall `make ci`
        - âœ¨Add check for test code coverage (integrate with badge).
        - `actions/cache`
            - âœ¨`GOMODCACHE`
                - âœ¨path: `go env GOMODCACHE`
                - âœ¨key: `${{ runner.os }}-gomodcache-${{ hashFiles('**/go.sum') }}`
                - âœ¨restore-keys: `${{ runner.os }}-gomodcache-`
            - âœ¨`GOCACHE`
                - âœ¨path: `go env GOCACHE`
                - âœ¨key: `${{ runner.os }}-gocache-${{ hashFiles('**/go.sum') }}-${{ hahFiles('**/*.go') }}`
                - âœ¨restore-keys: `${{ runner.os }}-gocache-`
            - âœ¨`staticcheck`
                - âœ¨path: `$XDG_CACHE_HOME/staticcheck` or `$HOME/.cache/staticcheck`
                - âœ¨key: `${{ runner.os }}-staticcheck-${{ hashFiles('**/go.sum') }}-${{ hahFiles('**/*.go') }}`
                - âœ¨restore-keys: `${{ runner.os }}-staticcheck-`
    - `.github/workflows/pull_request.yaml`
        - ðŸ§ªTriggers on all pull requests.
        - ðŸ§ªRuns `.github/actions/build.yaml`
        - âœ¨Use same base image as `devenv.sh`:a dd check to ensure both are in sync.
    - `.github/workflows/push.yaml`
        - ðŸ§ªTriggers on push to `master`.
        - ðŸ§ªRuns `.github/actions/build.yaml`
        - âœ¨Use same base image as `devenv.sh`:a dd check to ensure both are in sync.
    - `.github/workflows/release.yaml`
        - https://github.com/softprops/action-gh-release
        - ðŸ§ªTriggers on created tag
        - ðŸ“ˆPublish binary for linux-amd64.
        - ðŸ“ˆPublish GH Package: Container / Docker registry, so resonance can be used via `docker run`.
- README.md
    - Add badges
      - ðŸ§ªGH actions state
      - ðŸ§ªVersion
      - âœ¨Coverage
- âœ¨Add TESTS!
- `Makefile`
    - âœ¨Add https://github.com/gordonklaus/ineffassign
    - âœ¨Add https://github.com/client9/misspell
- `host/`
    - ðŸ§ªAdd option to use sudo to run commands.
    - `local.go`
        - âœ¨Use [subreaper to wait on all children](https://github.com/fornellas/rrb/blob/main/runner/runner.go).
    - `ssh.go`
        - ðŸ“ˆImplement using Go Ssh libraries.
- `resource/`
    - `alternatives.go`
        - Implement with `update-alternatives`.
    - `apt_update.go`
        - ðŸ“ˆCalls `apt-get update`.
        - ðŸ“ˆThere should be a single resource declaration
            - ðŸ“ˆImplicitly added if not present.
        - ðŸ“ˆIt must be `refreshed_by` `APTRepository`.
        - ðŸ“ˆParameters can be "freshness", so eg, if update is > freshness, then do update.
    - `apt_repository.go`:
        - ðŸ“ˆUse `add-apt-repository` to add at `/etc/apt/sources.list.d`
    - `apt_package.go`
        - ðŸ“ˆupport directly passing `.deb` packages.
        - Enforce after `File[/etc/apt/preferences.d/.+]`.
    - `file.go`
        - âœ¨Type: regular, link, dir, char device, block device, pipe, socket.
        - `Check`
            - âœ¨Print colored diff on content difference.
    - `group.go`
        - ðŸ“ˆManage groups.
    - `user.go`
        - ðŸ“ˆAfter `Group[.+]`.
    - `git.go`
        - ðŸ’¡Clone a git repository and clean checkout to a specific hash.
    - `hostname.go`
        - ðŸ’¡Set the hostname.
    - `network_manager.go`
        - ðŸ’¡Setup network interfaces.
    - `fstab.go`
        - ðŸ’¡Manage entries
    - `reboot.go`
        - ðŸ’¡Handle reboots (eg: for kernel upgrades).
    - `sysctl.go`
        - ðŸ’¡`/etc/sysctl.d/` file and refresh.
    - `iptables.go`
        - ðŸ’¡iptables configuration in disk & reload.
    - `hosts.go`
        - ðŸ’¡Manage entries.
    - `resource.go`
        - `Plan.Execute`
            - ðŸ§ªAt the end check again, fail if changes detected (bug in implementation).
            - ðŸ§ªAuto-rollback saved state on failures.
            - Parallelise check.
        - `LoadResourceBundles`
            - ðŸ§ªAdd check against duplicated resource `TypeName`.
            - ðŸ§ªReceive a single directory and load recursively from it.
            - Go templates
                - ðŸ“„Before parsing yaml, Go template each resource bundle yaml.
                - ðŸ“„Template is a function of:
                    - ðŸ“„`--host-parameters parms.yaml`, containing host specific stuff (Eg: secrets)
                    - ðŸ“„`HostInventory`
                        - ðŸ“„General information about the host.
                        - ðŸ“„Must only contains things that are NOT affected by any resource (eg: CPU, memory etc.)
                        - ðŸ“„Should save with state and check for changes?
                        - ðŸ“„After apply, reload `HostInventory`
                            - ðŸ“„If there are any changes, it means an implementation bug.
                            - ðŸ“„There may be valid corner cases here. In such scenarios:
                                - ðŸ“„`--allow-inventory-changes` have apply re-run when inventory changes at the end.
                                - ðŸ“„Should put a limit (otherwise, inifinite loops can happen).
        - `PersistantState`
            - Save history of states: enable to rollback to any previous state.
            - Local state: save to `XDG_STATE_HOME/resonance/$target_hostname/`
        - `ResourceDefinition`
            - âœ¨Support `refreshed_by`, to enable resources to subscribe to others (eg: `SystemdUnit[nginx.service]` is `refreshed_by` `File[/etc/nginx/.+]`)
        - `ManageableResource`
            - âœ¨Support defining implicit dependencies (eg: `Group` before `User`)
            - Check if current host OS is supported.
        - `Plan`
            - `Execute`
                - âœ¨Apply nodes concurrently for cases where it can be done (eg: no refresh).
            - `NewPlan`
                - âœ¨Run checks concurrently.
        - ðŸ“„High level & Primitive resources
            - ðŸ“„Primitive resources are the basic types (eg: `File`, `Package`)
            - ðŸ“„Support high level resources, that are declared individually, but when loaded, generate various primitive resources.
    - `systemd_unit.go`
        - ðŸ§ªManages https://www.freedesktop.org/software/systemd/man/systemd.unit.html
        - ðŸ§ªCalls `systemctl daemon-reload` on change.
        - ðŸ§ªOn refresh, do `systemctl reload-or-restart $unit`.
- ðŸ§ªEnable `KnownFields(true)` on all yaml decoders.
- `cli/`
    - `**/cmd.go`
        - âœ¨^C cancel context
    - `apply/cmd.go`
        - ðŸ§ªAsk for confirmation before running plan; add `--yes` to bypass.
    - `check/cmd.go`
        - ðŸ§ªimplement: checks host state / resources against host.
    - `plan/cmd.go`:
        - ðŸ§ªimplement: checks host state / resources and calculate plan against host.
        - ðŸ§ªAdd `--graphviz` option
        - âœ¨Add `--svg option` (generate the svg directly from the internal graphviz)
    - `lint/cmd.go`: implement:
        - âœ¨Validate resource definitions
        - âœ¨Lint yaml (format & sort)
    - `refresh/cmd.go`
        - ðŸ§ªUpdate state to match declared resources.
    - `destroy/cmd.go`
        - ðŸ§ªDestroy all resources at state.
    - `restore/cmd.go`
        - ðŸ§ªRestore machine to saved state.