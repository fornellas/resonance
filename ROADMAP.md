# Roadmap

- ðŸ§ªv0.1: MVP
    - Minimum CI /CD.
    - Basic types: `File`, `APTPackage`, `SystemdUnit`.
    - CLI with basic commands.
- âœ¨v0.2: Refinement
    - Add tests
    - Toughen CI
    - Speed, refine existing features, squash bugs.
    - Improve dependencies (type implicit and subscription).
- ðŸ“ˆv0.3 Expansion
    - Publish packages.
    - SSH support.
    - More resource types.
- ðŸ“„v0.4 Templating
    - Host inventory.
    - Generate resources with Go template.
    - "High level" resources can declare "primitive" resources.
- ðŸŒŽv1.0 Core features complete
    - Add help command with information on all resource types.
- ðŸ’¡v? TBD
    - Support different Linux Distributions (eg: some resources may require slightly different implementations).
    - Manage multiple hosts: do in parallel, all or nothnig for the whole group.

## Backlog

- GitHub Action
    - `.github/actions/build.yaml`
        - âœ¨Add check for test code coverage (integrate with badge).
        - âœ¨Fix cache for tools at `bin/` not working
- README.md
    - Add badges
      - âœ¨Coverage
- âœ¨Add TESTS!
- `host/`
    - âœ¨Add option to use sudo to run commands.
    - `local.go`
        - âœ¨Use [subreaper to wait on all children](https://github.com/fornellas/rrb/blob/main/runner/runner.go).
    - `ssh.go`
        - ðŸ“ˆImplement using Go Ssh libraries.
    - âœ¨Ensure execution environment is always the same.
- `resource/`
    - ðŸ’¡Merge `Resource` and `ManageableResource`.
    - `alternatives.go`
        - ðŸ’¡Implement with `update-alternatives`.
    - `apt_update.go`
        - ðŸ“ˆCalls `apt-get update`.
        - ðŸ“ˆThere should be a single resource declaration
            - ðŸ“ˆImplicitly added if not present.
        - ðŸ“ˆIt must be `refreshed_by` `APTRepository`.
        - ðŸ“ˆParameters can be "freshness", so eg, if update is > freshness, then do update.
    - `apt_repository.go`:
        - ðŸ“ˆUse `add-apt-repository` to add at `/etc/apt/sources.list.d`
    - `apt_package.go`
        - âœ¨Improve `APTPackageState.ValidateName`
        - âœ¨Improve `APTPackage.ValidateName`
        - âœ¨Enforce after `File[/etc/apt/preferences.d/.+]`.
        - ðŸ“ˆ Support directly passing `.deb` packages.
    - `file.go`
        - âœ¨Type: regular, link, dir, char device, block device, pipe, socket.
    - `group.go`
        - ðŸ“ˆManage groups.
    - `user.go`
        - ðŸ“ˆAfter `Group[.+]`.
    - `git.go`
        - ðŸ’¡Clone a git repository and clean checkout to a specific hash.
    - `hostname.go`
        - ðŸ’¡Set the hostname.
    - `network_manager.go`
        - ðŸ’¡Setup network interfaces.
    - `fstab.go`
        - ðŸ’¡Manage entries
    - `reboot.go`
        - ðŸ’¡Handle reboots (eg: for kernel upgrades).
    - `sysctl.go`
        - ðŸ’¡`/etc/sysctl.d/` file and refresh.
    - `iptables.go`
        - ðŸ’¡iptables configuration in disk & reload.
    - `hosts.go`
        - ðŸ’¡Manage entries.
    - `resource.go`
        - ðŸ§ªAdd common interface at `Resource` to request a resource to be destroyed.
        - ðŸ§ªSwap diff for https://pkg.go.dev/github.com/kylelemons/godebug/diff.
        - `Plan.Execute`
            - âœ¨Parallelise check.
        - `LoadResourceBundles`
            - Go templates
                - ðŸ“„Before parsing yaml, Go template each resource bundle yaml.
                - ðŸ“„Template is a function of:
                    - ðŸ“„`--host-parameters parms.yaml`, containing host specific stuff (Eg: secrets)
                    - ðŸ“„`HostInventory`
                        - ðŸ“„General information about the host.
                        - ðŸ“„Must only contains things that are NOT affected by any resource (eg: CPU, memory etc.)
                        - ðŸ“„Should save with state and check for changes?
                        - ðŸ“„After apply, reload `HostInventory`
                            - ðŸ“„If there are any changes, it means an implementation bug.
                            - ðŸ“„There may be valid corner cases here. In such scenarios:
                                - ðŸ“„`--allow-inventory-changes` have apply re-run when inventory changes at the end.
                                - ðŸ“„Should put a limit (otherwise, inifinite loops can happen).
        - `PersistantState`
            - âœ¨Save history of states: enable to rollback to any previous state.
            - âœ¨Support `refreshed_by`, to enable resources to subscribe to others (eg: `SystemdUnit[nginx.service]` is `refreshed_by` `File[/etc/nginx/.+]`)
        - `ManageableResource`
            - âœ¨Support defining implicit dependencies (eg: `Group` before `User`)
            - Check if current host OS is supported.
        - `Plan`
            - `Execute`
                - âœ¨Apply nodes concurrently for cases where it can be done (eg: no refresh).
            - `NewPlan`
                - âœ¨Run checks concurrently.
        - ðŸ“„High level & Primitive resources
            - ðŸ“„Primitive resources are the basic types (eg: `File`, `Package`)
            - ðŸ“„Support high level resources, that are declared individually, but when loaded, generate various primitive resources.
    - `systemd_unit.go`
        - ðŸ§ªManages https://www.freedesktop.org/software/systemd/man/systemd.unit.html
        - ðŸ§ªCalls `systemctl daemon-reload` on change.
        - ðŸ§ªOn refresh, do `systemctl reload-or-restart $unit`.
- `cli/`
    - `**/cmd.go`
        - âœ¨^C cancel context
    - `apply/cmd.go`
        - ðŸ§ªWhen `apply` runs, `initialHostState` should keep both previous `savedHostState` and `bundlesHostState` to be saved before apply is attepmted.
          - ðŸ§ªIf apply fails, this dirty state must be detected by subsequent `LoadHostState` calls, and if dirty, suggest running `restore`.
        - âœ¨Ask for confirmation before running plan; add `--yes` to bypass.
    - `lint/cmd.go`: implement:
        - âœ¨Validate resource definitions
        - âœ¨Lint yaml (format & sort)
    - `help/cmd.go`
        - ðŸŒŽShow help on schema for resource files.
        - ðŸŒŽShow help on each resource type and its configuration parameters