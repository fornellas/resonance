# Roadmap

- ðŸ§ªMVP
    - Minimum CI /CD.
    - Basic types: `File`, `APTPackage`, `SystemdUnit`.
    - CLI with basic commands.
- âœ¨Refinement
    - Add tests
    - Toughen CI
    - Speed, refine existing features, squash bugs.
    - Improve dependencies (type implicit and subscription).
- ðŸ“ˆExpansion
    - Publish packages.
    - SSH support.
    - More resource types.
- ðŸ“„Templating
    - Host inventory.
    - Generate resources with Go template.
    - "High level" resources can declare "primitive" resources.
- ðŸŒŽCore features complete
    - Add help command with information on all resource types.
- ðŸ’¡Ideas
    - Support different Linux Distributions (eg: some resources may require slightly different implementations).
    - Manage multiple hosts: do in parallel, all or nothnig for the whole group.

## Backlog

- GitHub Action
    - `.github/actions/build.yaml`
        - âœ¨Fix cache for tools at `bin/` not working
- Documentation
    - âœ¨README.md
      - âœ¨Usage example.
    - âœ¨Resources
- Add TESTS!
    - ðŸ’¡Run tests for all `GOARCH`, eg: find all modules with `go list github.com/fornellas/resonance/...`, compile each with `go test -c $package -o $package_path.$GOARCH.test` then run each test. If non-native `GOARCH`, use `qemu-user` (`qemu-arch`, `qemu-aarch64`).
    - âœ¨`RefreshableManageableResource`
    - âœ¨`resource/types/file.go`
    - âœ¨`resource/types/apt_package.go`
- `host/`
    - `local.go`
        - âœ¨Use [subreaper to wait on all children](https://github.com/fornellas/rrb/blob/main/runner/runner.go).
    - `ssh.go`
        - ðŸ“ˆImplement using Go Ssh libraries.
    - âœ¨Ensure execution environment is always the same.
- `resource/`
    - `bundle.go`
        - `LoadResourceBundles`
            - Go templates
                - ðŸ“„Before parsing yaml, Go template each resource bundle yaml.
                - ðŸ“„Template is a function of:
                    - ðŸ“„`--host-parameters parms.yaml`, containing host specific stuff (Eg: secrets)
                    - ðŸ“„`HostInventory`
                        - ðŸ“„General information about the host.
                        - ðŸ“„Must only contains things that are NOT affected by any resource (eg: CPU, memory etc.)
                        - ðŸ“„Should save with state and check for changes?
                        - ðŸ“„After apply, reload `HostInventory`
                            - ðŸ“„If there are any changes, it means an implementation bug.
                            - ðŸ“„There may be valid corner cases here. In such scenarios:
                                - ðŸ“„`--allow-inventory-changes` have apply re-run when inventory changes at the end.
                                - ðŸ“„Should put a limit (otherwise, inifinite loops can happen).
    - `resource.go`
        - ðŸ’¡Merge `Resource` and `ManageableResource`.
        - âœ¨Parallelize checks at `GetTypeNameStateMap`.
        - âœ¨Support defining implicit dependencies (eg: `Group` before `User`)
        - ðŸ’¡Check if current host OS is supported.
        - ðŸ“„High level & Primitive resources
            - ðŸ“„Primitive resources are the basic types (eg: `File`, `Package`)
            - ðŸ“„Support high level resources, that are declared individually, but when loaded, generate various primitive resources.
    - `types/`
        - `*.go`
            - ðŸ’¡Merge `File` and `FileState` (same for other types).
        - `alternatives.go`
            - ðŸ“ˆImplement with `update-alternatives`.
        - `apt_update.go`
            - ðŸ“ˆCalls `apt-get update`.
            - ðŸ“ˆThere should be a single resource declaration
                - ðŸ“ˆImplicitly added if not present.
            - ðŸ“ˆIt must be `refreshed_by` `APTRepository`.
            - ðŸ“ˆParameters can be "freshness", so eg, if update is > freshness, then do update.
        - `apt_repository.go`:
            - ðŸ“ˆUse `add-apt-repository` to add at `/etc/apt/sources.list.d`
        - `apt_package.go`
            - âœ¨Improve `APTPackageState.ValidateName`
            - âœ¨Improve `APTPackage.ValidateName`
            - âœ¨Enforce after `File[/etc/apt/preferences.d/.+]`.
            - ðŸ“ˆ Support directly passing `.deb` packages.
        - `file.go`
            - âœ¨Type: regular, link, dir, char device, block device, pipe, socket.
        - `git.go`
            - ðŸ’¡Clone a git repository and clean checkout to a specific hash.
        - `group.go`
            - ðŸ“ˆManage groups.
        - `hostname.go`
            - ðŸ’¡Set the hostname.
        - `hosts.go`
            - ðŸ’¡Manage entries.
        - `iptables.go`
            - ðŸ’¡iptables configuration in disk & reload.
        - `network_manager.go`
            - ðŸ’¡Setup network interfaces.
        - `fstab.go`
            - ðŸ’¡Manage entries
        - `reboot.go`
            - ðŸ’¡Handle reboots (eg: for kernel upgrades).
        - `sysctl.go`
            - ðŸ’¡`/etc/sysctl.d/` file and refresh.
        - `systemd_unit.go`
            - ðŸ§ªManages https://www.freedesktop.org/software/systemd/man/systemd.unit.html
            - ðŸ§ªCalls `systemctl daemon-reload` on change.
            - ðŸ§ªOn refresh, do `systemctl reload-or-restart $unit`.
        - `user.go`
            - ðŸ“ˆAfter `Group[.+]`.
    - `plan.go`
        - âœ¨Apply nodes concurrently for cases where it can be done (eg: no refresh).
        - ðŸ’¡After `Plan.Execute` , validate the full state again to detect any cross-resource state breakage.
    - `state.go`
        - `PersistantState`
            - âœ¨Save history of states: enable to rollback to any previous state.
            - âœ¨Support `refreshed_by`, to enable resources to subscribe to others (eg: `SystemdUnit[nginx.service]` is `refreshed_by` `File[/etc/nginx/.+]`)
- `cli/`
    - `**/cmd.go`
        - âœ¨^C cancel context
        - âœ¨Ask for confirmation before running plan; add `--yes` to bypass.
    - `lint/cmd.go`: implement:
        - ðŸ’¡Validate resource definitions
        - ðŸ’¡Lint yaml (format & sort)
    - `help/cmd.go`
        - ðŸŒŽShow help on schema for resource files.
        - ðŸŒŽShow help on each resource type and its configuration parameters